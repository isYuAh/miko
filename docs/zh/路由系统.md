# è·¯ç”±ç³»ç»Ÿ

Miko æä¾›äº†çµæ´»è€Œå¼ºå¤§çš„è·¯ç”±ç³»ç»Ÿï¼Œæ”¯æŒè·¯ç”±å®ã€æ‰‹åŠ¨æ³¨å†Œã€è·¯å¾„å‚æ•°ã€åµŒå¥—è·¯ç”±ç­‰åŠŸèƒ½ã€‚

## è·¯ç”±å®šä¹‰æ–¹å¼

### ä½¿ç”¨è·¯ç”±å®ï¼ˆæ¨èï¼‰

ä½¿ç”¨ `#[get]`ã€`#[post]` ç­‰å®å®šä¹‰è·¯ç”±ï¼Œé…åˆ `#[miko]` å®ç°è‡ªåŠ¨æ³¨å†Œï¼š

> **éœ€è¦ `macro` featureï¼Œè‡ªåŠ¨æ³¨å†Œéœ€è¦ `auto` feature**

```rust
use miko::*;
use miko::macros::*;

#[get("/")]
async fn index() -> &'static str {
    "Home"
}

#[get("/users")]
async fn list_users() -> &'static str {
    "User list"
}

#[post("/users")]
async fn create_user() -> &'static str {
    "User created"
}

#[miko]
async fn main() {
    // è·¯ç”±è‡ªåŠ¨æ”¶é›†å’Œæ³¨å†Œ
}
```

### æ‰‹åŠ¨æ³¨å†Œè·¯ç”±ï¼ˆrouteçš„æ—¶å€™å·²ç»å°†stateæ³¨å…¥åˆ°äº†handleré‡Œï¼Œæ‰€ä»¥è·¯ç”±å®ä¸æ”¯æŒstateï¼Œå¹¶ä¸”éœ€è¦å…ˆwith_stateå†æŒ‚è½½è·¯ç”±ï¼‰

å¦‚æœä¸ä½¿ç”¨å®ï¼Œå¯ä»¥æ‰‹åŠ¨æ³¨å†Œï¼š

```rust
use miko::*;

async fn index() -> &'static str {
    "Home"
}

#[tokio::main]
async fn main() {
    let router = Router::new()
        .get("/", index)
        .post("/users", create_user)
        .put("/users/{id}", update_user)
        .delete("/users/{id}", delete_user);

    let config = ApplicationConfig::default();
    Application::new(config, router).run().await.unwrap();
}
```

### è‡ªå®šä¹‰æ–¹æ³•å’Œè·¯å¾„

ä½¿ç”¨ `#[route]` å®è‡ªå®šä¹‰ HTTP æ–¹æ³•ï¼ˆå…¶å®å…¶ä»–çš„ä¹Ÿå¯ä»¥æ‹“å±•æ–¹æ³•ï¼Œä¾‹å¦‚`#[get("/", method="post,put")]`ï¼‰ï¼š

```rust
use hyper::Method;

// ä½¿ç”¨å®
#[route("/api/data", method = "get")]
async fn get_data() -> &'static str {
    "Data"
}

// æˆ–æ‰‹åŠ¨æ³¨å†Œ
router.route(Method::PATCH, "/api/data", patch_handler);
```

## å¯ç”¨çš„è·¯ç”±å®

Miko æä¾›äº†æ‰€æœ‰å¸¸ç”¨ HTTP æ–¹æ³•çš„å®ï¼š

| å® | HTTP æ–¹æ³• | ç”¨é€” |
|---|-----------|------|
| `#[get]` | GET | è·å–èµ„æº |
| `#[post]` | POST | åˆ›å»ºèµ„æº |
| `#[put]` | PUT | æ›´æ–°èµ„æºï¼ˆå®Œæ•´ï¼‰ |
| `#[patch]` | PATCH | æ›´æ–°èµ„æºï¼ˆéƒ¨åˆ†ï¼‰ |
| `#[delete]` | DELETE | åˆ é™¤èµ„æº |
| `#[head]` | HEAD | è·å–å…ƒä¿¡æ¯ |
| `#[options]` | OPTIONS | è·å–æ”¯æŒçš„æ–¹æ³• |

æ‰€æœ‰å®éƒ½æ”¯æŒ `#[route]` çš„å‚æ•°æ³¨è§£åŠŸèƒ½ã€‚

## è·¯å¾„å‚æ•°

### å®šä¹‰è·¯å¾„å‚æ•°

ä½¿ç”¨ `{å‚æ•°å}` å®šä¹‰è·¯å¾„å‚æ•°ï¼š

```rust
#[get("/users/{id}")]
async fn get_user(Path(id): Path<u32>) -> String {
    format!("User ID: {}", id)
}

#[get("/posts/{post_id}/comments/{comment_id}")]
async fn get_comment(
    Path(post_id): Path<u32>,
    Path(comment_id): Path<u32>
) -> String {
    format!("Post: {}, Comment: {}", post_id, comment_id)
}
```

### ä½¿ç”¨ `#[path]` æ³¨è§£

ä½¿ç”¨å®çš„å‚æ•°æ³¨è§£åŠŸèƒ½æ›´ç®€æ´ï¼š

```rust
#[get("/users/{id}")]
async fn get_user(#[path] id: u32) -> String {
    format!("User ID: {}", id)
}

#[get("/users/{user_id}/posts/{post_id}")]
async fn get_user_post(
    #[path] user_id: u32,
    #[path] post_id: u32,
) -> String {
    format!("User {}, Post {}", user_id, post_id)
}
```

### ç±»å‹å®‰å…¨

è·¯å¾„å‚æ•°æ”¯æŒä»»ä½•å®ç° `FromStr` çš„ç±»å‹ï¼š

```rust
use uuid::Uuid;

#[get("/items/{id}")]
async fn get_item(#[path] id: Uuid) -> String {
    format!("Item UUID: {}", id)
}

#[get("/products/{slug}")]
async fn get_product(#[path] slug: String) -> String {
    format!("Product: {}", slug)
}
```

å¦‚æœç±»å‹è½¬æ¢å¤±è´¥ï¼Œä¼šè‡ªåŠ¨è¿”å› 400 Bad Request é”™è¯¯ã€‚

## è·¯ç”±åµŒå¥—

### ä½¿ç”¨ `nest` æ–¹æ³•ï¼ˆæ³¨æ„stateæ˜¯ç»§æ‰¿è‡ªåŸæœ¬çš„routerï¼Œæ¢å¥è¯è¯´routeçš„æ—¶å€™å·²ç»å°†stateæ³¨å…¥åˆ°äº†handleré‡Œï¼‰

ä¸ºä¸€ç»„è·¯ç”±æ·»åŠ ç»Ÿä¸€å‰ç¼€ï¼š

```rust
use miko::*;
use miko::macros::*;

// API v1 è·¯ç”±
#[get("/users")]
async fn v1_users() -> &'static str { "API v1 users" }

#[get("/posts")]
async fn v1_posts() -> &'static str { "API v1 posts" }

// API v2 è·¯ç”±
#[get("/users")]
async fn v2_users() -> &'static str { "API v2 users" }

#[tokio::main]
async fn main() {
    let v1_router = Router::new()
        .get("/users", v1_users)
        .get("/posts", v1_posts);

    let v2_router = Router::new()
        .get("/users", v2_users);

    let router = Router::new()
        .nest("/api/v1", v1_router)
        .nest("/api/v2", v2_router);

    // è®¿é—® /api/v1/users, /api/v1/posts, /api/v2/users

    let config = ApplicationConfig::default();
    Application::new(config, router).run().await.unwrap();
}
```

### ä½¿ç”¨ `merge` æ–¹æ³•

åˆå¹¶ä¸¤ä¸ªè·¯ç”±å™¨ï¼š

```rust
let user_router = Router::new()
    .get("/users", list_users)
    .get("/users/{id}", get_user);

let post_router = Router::new()
    .get("/posts", list_posts)
    .get("/posts/{id}", get_post);

let router = Router::new()
    .merge(user_router)
    .merge(post_router);
```

### æ¨¡å—åŒ–è·¯ç”±

æ¨èæŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡è·¯ç”±ï¼š

```rust
// src/routes/users.rs
use miko::*;
use miko::macros::*;

#[get("/users")]
pub async fn list() -> &'static str { "Users" }

#[get("/users/{id}")]
pub async fn get(#[path] id: u32) -> String {
    format!("User {}", id)
}

pub fn router() -> Router {
    Router::new()
        .get("/users", list)
        .get("/users/{id}", get)
}

// src/routes/posts.rs
use miko::*;
use miko::macros::*;

#[get("/posts")]
pub async fn list() -> &'static str { "Posts" }

pub fn router() -> Router {
    Router::new()
        .get("/posts", list)
}

// src/main.rs
mod routes;

#[tokio::main]
async fn main() {
    let router = Router::new()
        .merge(routes::users::router())
        .merge(routes::posts::router());

    let config = ApplicationConfig::default();
    Application::new(config, router).run().await.unwrap();
}
```

## æ¨¡å—è·¯ç”±ä¸å‰ç¼€

### #[prefix] å®

ä½¿ç”¨ `#[prefix]` å®ä¸ºæ¨¡å—å†…æ‰€æœ‰è·¯ç”±æ·»åŠ è·¯å¾„å‰ç¼€:

```rust
use miko::*;
use miko::macros::*;

#[prefix("/api")]
mod api {
    #[get("/users")]
    async fn list_users() -> &'static str {
        "users"  // å®é™…è·¯å¾„: GET /api/users
    }

    #[get("/posts")]
    async fn list_posts() -> &'static str {
        "posts"  // å®é™…è·¯å¾„: GET /api/posts
    }
}

#[prefix("/admin")]
mod admin {
    #[get("/users")]
    async fn admin_users() -> &'static str {
        "admin users"  // å®é™…è·¯å¾„: GET /admin/users
    }
}

#[miko]
async fn main() {
    // æ¨¡å—å†…è·¯ç”±è‡ªåŠ¨å¸¦å‰ç¼€
}
```

### åµŒå¥—å‰ç¼€

`#[prefix]` æ”¯æŒåµŒå¥—ä½¿ç”¨:

```rust
#[prefix("/api")]
mod api {
    #[prefix("/v1")]
    mod v1 {
        #[get("/users")]
        async fn list_users() -> &'static str {
            "v1 users"  // å®é™…è·¯å¾„: GET /api/v1/users
        }
    }

    #[prefix("/v2")]
    mod v2 {
        #[get("/users")]
        async fn list_users() -> &'static str {
            "v2 users"  // å®é™…è·¯å¾„: GET /api/v2/users
        }
    }
}
```

### prefix ä¸ nest çš„åŒºåˆ«

| ç‰¹æ€§ | `#[prefix]` | `Router::nest` |
|------|-------------|----------------|
| ä½¿ç”¨ä½ç½® | æ¨¡å—çº§åˆ«ï¼ˆç¼–è¯‘æ—¶ï¼‰ | Router çº§åˆ«ï¼ˆè¿è¡Œæ—¶ï¼‰ |
| è·¯å¾„å¤„ç† | ç®€å•å‰ç¼€æ‹¼æ¥ | çœŸæ­£çš„è·¯ç”±åµŒå¥—ï¼Œä¼šä¿®æ”¹å†…éƒ¨è·¯å¾„ |
| ä½¿ç”¨åœºæ™¯ | æ¨¡å—åŒ–ä»£ç ç»„ç»‡ | åŠ¨æ€è·¯ç”±ç»„åˆ |

```rust
// #[prefix] - ç¼–è¯‘æ—¶å‰ç¼€
#[prefix("/api")]
mod api {
    #[get("/users")]  // ç¼–è¯‘å: GET /api/users
    async fn users() { }
}

// nest - è¿è¡Œæ—¶åµŒå¥—
let api_router = Router::new()
    .get("/users", users);

let router = Router::new()
    .nest("/api", api_router);  // è¿è¡Œæ—¶: GET /api/users
```

### ç»„åˆä½¿ç”¨

`#[prefix]` å¯ä»¥å’Œ `#[layer]` ä¸€èµ·ä½¿ç”¨:

```rust
use tower_http::timeout::TimeoutLayer;
use std::time::Duration;

#[prefix("/api")]
#[layer(TimeoutLayer::new(Duration::from_secs(30)))]
mod api {
    #[get("/users")]
    async fn users() -> &'static str {
        "users"  // GET /api/usersï¼Œå¸¦ 30 ç§’è¶…æ—¶
    }
}
```

## è·¯ç”±ä¼˜å…ˆçº§

è·¯ç”±åŒ¹é…ï¼Œé™æ€è·¯ç”±ä¼šè¢«ä¼˜å…ˆåŒ¹é…ï¼š

```rust
let router = Router::new()
    .get("/users/me", get_current_user)      // å…ˆæ³¨å†Œå…·ä½“è·¯å¾„
    .get("/users/{id}", get_user);           // åæ³¨å†Œå‚æ•°è·¯å¾„
```

`/users/me` å’Œ `/users/{id}` éƒ½åŒ¹é…åˆ°ï¼Œä½†æ˜¯meæ˜¯é™æ€è·¯ç”±

## é€šé…ç¬¦è·¯ç”±

åŒ¹é…ä»»æ„è·¯å¾„æ®µï¼š

```rust
// åŒ¹é… /files/ åçš„æ‰€æœ‰è·¯å¾„
#[get("/files/{*path}")]
async fn serve_file(Path(path): Path<String>) -> String {
    format!("Serving file: {}", path)
}

// è®¿é—® /files/docs/guide.md
// path = "docs/guide.md"
```

## è·¯ç”±ç»„ä¸ä¸­é—´ä»¶

ä¸ºä¸€ç»„è·¯ç”±åº”ç”¨ç›¸åŒçš„ä¸­é—´ä»¶ï¼ˆåœ¨mergeï¼Œnestï¼Œinto_tower_serviceæ‰ä¼šç”Ÿæ•ˆï¼Œæ‰€ä»¥æ·»åŠ æ—¶æœºè¦æ±‚æ¯”è¾ƒå®½æ¾ï¼‰ï¼š

```rust
use tower::ServiceBuilder;
use tower_http::trace::TraceLayer;

let protected_router = Router::new()
    .get("/admin/users", admin_users)
    .get("/admin/settings", admin_settings)
    .with_layer(auth_middleware());  // åªåº”ç”¨äºè¿™äº›è·¯ç”±

let public_router = Router::new()
    .get("/", index)
    .get("/about", about);

let router = Router::new()
    .merge(public_router)
    .merge(protected_router)
    .layer(TraceLayer::new_for_http());  // åº”ç”¨äºæ‰€æœ‰è·¯ç”±
```

è¯¦è§ [ä¸­é—´ä»¶ä¸å±‚](ä¸­é—´ä»¶ä¸å±‚.md)ã€‚

## è·¯ç”±å¤„ç†å™¨

### Handler ç­¾å

Handler æ˜¯ä»»ä½•æ»¡è¶³ä»¥ä¸‹æ¡ä»¶çš„å¼‚æ­¥å‡½æ•°ï¼š
- å‚æ•°å®ç° `FromRequest` æˆ– `FromRequestParts`
- è¿”å›ç±»å‹å®ç° `IntoResponse`

```rust
// æ— å‚æ•°
async fn handler() -> &'static str { "Hello" }

// å•ä¸ªå‚æ•°
async fn with_json(Json(data): Json<MyData>) -> Json<Response> {
    // ...
}

// å¤šä¸ªå‚æ•°
async fn complex_handler(
    Path(id): Path<u32>,
    Query(params): Query<HashMap<String, String>>,
    Json(body): Json<CreateData>,
    State(db): State<Database>,
) -> AppResult<Json<Response>> {
    // ...
}
```

### å‚æ•°æå–é¡ºåº

æå–å™¨æœ‰ä¸¤ç§ç±»å‹ï¼š

1. **FromRequestParts** - ä¸æ¶ˆè´¹è¯·æ±‚ä½“ï¼ˆPathã€Queryã€Headersã€State ç­‰ï¼‰
2. **FromRequest** - å¯èƒ½æ¶ˆè´¹è¯·æ±‚ä½“ï¼ˆJsonã€Formã€Multipart ç­‰ï¼‰

ä½ å¯ä»¥æœ‰å¤šä¸ª `FromRequestParts` æå–å™¨ï¼Œä½†åªèƒ½æœ‰ä¸€ä¸ª `FromRequest` æå–å™¨ï¼š

```rust
// âœ… æ­£ç¡®
async fn handler(
    Path(id): Path<u32>,           // FromRequestParts
    Query(q): Query<MyQuery>,       // FromRequestParts
    headers: HeaderMap,             // FromRequestParts
    Json(body): Json<MyData>,       // FromRequest
) { }

// âŒ é”™è¯¯ - ä¸èƒ½æœ‰ä¸¤ä¸ª FromRequest
async fn bad_handler(
    Json(body1): Json<Data1>,       // FromRequest
    Json(body2): Json<Data2>,       // FromRequest - ç¼–è¯‘é”™è¯¯ï¼
) { }
```

### è¿”å›ç±»å‹

æˆ‘ä»¬è·¯ç”±ç›¸å…³ç±»å‹å®šä¹‰å¦‚ä¸‹
```rust
pub type RespBody = BoxBody<Bytes, Infallible>;
pub type Resp = Response<RespBody>;
pub type Req = Request<RespBody>;
```

Handler å¯ä»¥è¿”å›ä»»ä½•å®ç° `IntoResponse` çš„ç±»å‹ï¼š

```rust
// å­—ç¬¦ä¸²
async fn text() -> &'static str { "Hello" }

// JSON
async fn json() -> Json<User> { Json(user) }

// å¸¦çŠ¶æ€ç 
async fn created() -> (StatusCode, Json<User>) {
    (StatusCode::CREATED, Json(user))
}

// Result
async fn fallible() -> AppResult<Json<User>> {
    Ok(Json(user))
}

// è‡ªå®šä¹‰å“åº”ï¼ˆï¼‰
async fn custom() -> impl IntoResponse {
    Response::builder()
        .status(StatusCode::OK)
        .header("X-Custom", "value")
        .body(Full::new(Bytes::from("Hello")).boxed())
        .unwrap()
}
```

è¯¦è§ [å“åº”å¤„ç†](å“åº”å¤„ç†.md)ã€‚

## å®Œæ•´ç¤ºä¾‹

ä¸€ä¸ªå±•ç¤ºå„ç§è·¯ç”±åŠŸèƒ½çš„å®Œæ•´ç¤ºä¾‹ï¼š

```rust
use miko::{*, extractor::{Json, Path, Query}};
use miko::macros::*;
use serde::{Deserialize, Serialize};
use std::collections::HashMap;

#[derive(Serialize, Deserialize)]
struct User {
    id: u32,
    name: String,
}

#[derive(Serialize, Deserialize, Debug)]
struct MyQuery {
    id: u32,
    name: String,
}

// åŸºç¡€è·¯ç”±
#[get("/")]
async fn index() -> &'static str {
    "Welcome"
}

// è·¯å¾„å‚æ•°
#[get("/users/{id}")]
async fn get_user(#[path] id: u32) -> Json<User> {
    Json(User { id, name: format!("User {}", id) })
}

// æŸ¥è¯¢å‚æ•°
#[get("/search")]
async fn search(Query(params): Query<MyQuery>) -> String {
    format!("Query: {:?}", params)
}

// POST è¯·æ±‚
#[post("/users")]
async fn create_user(Json(user): Json<User>) -> (StatusCode, Json<User>) {
    (StatusCode::CREATED, Json(user))
}

// å¤šä¸ªè·¯å¾„å‚æ•°
#[get("/users/{user_id}/posts/{post_id}")]
async fn get_user_post(
    #[path] user_id: u32,
    #[path] post_id: u32,
) -> String {
    format!("User {}, Post {}", user_id, post_id)
}

#[miko]
async fn main() {
    println!("ğŸš€ Server running on http://localhost:8080");
}
```

## ä¸‹ä¸€æ­¥

- ğŸ” å­¦ä¹  [è¯·æ±‚æå–å™¨](è¯·æ±‚æå–å™¨.md) çš„è¯¦ç»†ç”¨æ³•
- ğŸ“¤ äº†è§£ [å“åº”å¤„ç†](å“åº”å¤„ç†.md) çš„å„ç§æ–¹å¼
- ğŸ” ä½¿ç”¨ [ä¸­é—´ä»¶ä¸å±‚](ä¸­é—´ä»¶ä¸å±‚.md) æ·»åŠ è®¤è¯ç­‰åŠŸèƒ½
