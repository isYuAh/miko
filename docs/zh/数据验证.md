# æ•°æ®éªŒè¯

> **éœ€è¦ `validation` feature**

Miko æä¾› `ValidatedJson` æå–å™¨,è‡ªåŠ¨éªŒè¯è¯·æ±‚æ•°æ®å¹¶è¿”å›ç»Ÿä¸€çš„é”™è¯¯å“åº”ã€‚åº•å±‚ä½¿ç”¨ [garde](https://github.com/jprochazk/garde) éªŒè¯åº“ã€‚

## æ ¸å¿ƒåŠŸèƒ½

### ValidatedJson æå–å™¨

ç”¨ `ValidatedJson` æ›¿ä»£ `Json`,è‡ªåŠ¨æ‰§è¡ŒéªŒè¯:

```rust
use miko::*;

#[derive(Deserialize, Validate)]
struct CreateUser {
    #[garde(length(min = 3, max = 20))]
    username: String,

    #[garde(email)]
    email: String,

    #[garde(length(min = 8))]
    password: String,

    #[garde(range(min = 18, max = 120))]
    age: u8,
}

#[post("/users")]
async fn create_user(
    ValidatedJson(data): ValidatedJson<CreateUser>
) -> impl IntoResponse {
    // âœ… data å·²é€šè¿‡éªŒè¯
    Json(json!({
        "message": "ç”¨æˆ·åˆ›å»ºæˆåŠŸ",
        "username": data.username
    }))
}
```

**å¯¹æ¯”æ™®é€š Json æå–å™¨:**

```rust
// âŒ ä½¿ç”¨ Json - æ— éªŒè¯
#[post("/users")]
async fn create_user(Json(data): Json<CreateUser>) -> impl IntoResponse {
    // âš ï¸ data å¯èƒ½åŒ…å«æ— æ•ˆæ•°æ®
    // éœ€è¦æ‰‹åŠ¨éªŒè¯
}

// âœ… ä½¿ç”¨ ValidatedJson - è‡ªåŠ¨éªŒè¯
#[post("/users")]
async fn create_user(ValidatedJson(data): ValidatedJson<CreateUser>) -> impl IntoResponse {
    // âœ… data å·²é€šè¿‡æ‰€æœ‰éªŒè¯è§„åˆ™
}
```

### è‡ªåŠ¨é”™è¯¯å“åº”

éªŒè¯å¤±è´¥è‡ªåŠ¨è¿”å› 422 é”™è¯¯:

```json
{
  "status": 422,
  "error": "VALIDATION_ERROR",
  "message": "Request validation failed",
  "details": {
    "fields": [
      {
        "field": "username",
        "message": "username length must be between 3 and 20",
        "code": "VALIDATION_FAILED"
      },
      {
        "field": "email",
        "message": "email has invalid format, expected: valid email address",
        "code": "VALIDATION_FAILED"
      }
    ]
  },
  "trace_id": "trace-123abc",
  "timestamp": 1234567890
}
```

> é”™è¯¯å“åº”æ ¼å¼ä¸æ¡†æ¶çš„ [é”™è¯¯å¤„ç†](é”™è¯¯å¤„ç†.md) ç³»ç»Ÿä¸€è‡´ã€‚

## å¸¸ç”¨éªŒè¯è§„åˆ™

### å­—ç¬¦ä¸²éªŒè¯

```rust
#[derive(Deserialize, Validate)]
struct StringExample {
    // é•¿åº¦é™åˆ¶
    #[garde(length(min = 3, max = 50))]
    username: String,

    // é‚®ç®±æ ¼å¼
    #[garde(email)]
    email: String,

    // URL æ ¼å¼
    #[garde(url)]
    website: Option<String>,

    // æ­£åˆ™è¡¨è¾¾å¼
    #[garde(pattern(r"^[A-Z]{2}\d{4}$"))]
    code: String,
}
```

### æ•°å€¼éªŒè¯

```rust
#[derive(Deserialize, Validate)]
struct NumberExample {
    // èŒƒå›´
    #[garde(range(min = 18, max = 120))]
    age: u8,

    // æœ€å°å€¼
    #[garde(range(min = 0.0))]
    price: f64,
}
```

### é›†åˆéªŒè¯

```rust
#[derive(Deserialize, Validate)]
struct CollectionExample {
    // æ•°ç»„é•¿åº¦
    #[garde(length(min = 1, max = 10))]
    tags: Vec<String>,

    // éªŒè¯æ•°ç»„å†…æ¯ä¸ªå…ƒç´ 
    #[garde(dive)]
    items: Vec<Item>,
}

#[derive(Deserialize, Validate)]
struct Item {
    #[garde(length(min = 1))]
    name: String,
}
```

### åµŒå¥—å¯¹è±¡éªŒè¯

```rust
#[derive(Deserialize, Validate)]
struct UserProfile {
    #[garde(length(min = 3))]
    username: String,

    // éªŒè¯åµŒå¥—å¯¹è±¡
    #[garde(dive)]
    address: Address,
}

#[derive(Deserialize, Validate)]
struct Address {
    #[garde(length(min = 1))]
    street: String,

    #[garde(length(min = 1))]
    city: String,
}
```

## è‡ªå®šä¹‰éªŒè¯

### ç®€å•è‡ªå®šä¹‰

```rust
#[derive(Deserialize, Validate)]
struct User {
    #[garde(custom(validate_username))]
    username: String,
}

fn validate_username(value: &str, _ctx: &()) -> garde::Result {
    if value.to_lowercase() == "admin" {
        return Err(garde::Error::new("ç”¨æˆ·å 'admin' ä¸å¯ç”¨"));
    }
    Ok(())
}
```

### å¤æ‚éªŒè¯é€»è¾‘

```rust
#[derive(Deserialize, Validate)]
struct CreateUser {
    #[garde(length(min = 8), custom(strong_password))]
    password: String,
}

fn strong_password(value: &str, _ctx: &()) -> garde::Result {
    let has_upper = value.chars().any(|c| c.is_uppercase());
    let has_lower = value.chars().any(|c| c.is_lowercase());
    let has_digit = value.chars().any(|c| c.is_numeric());

    if !has_upper || !has_lower || !has_digit {
        return Err(garde::Error::new(
            "å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯ã€å°å†™å­—æ¯å’Œæ•°å­—"
        ));
    }
    Ok(())
}
```

## å®Œæ•´ç¤ºä¾‹

```rust
use miko::*;

#[derive(Deserialize, Validate)]
struct RegisterRequest {
    #[garde(length(min = 3, max = 20))]
    username: String,

    #[garde(email)]
    email: String,

    #[garde(length(min = 8), custom(strong_password))]
    password: String,

    #[garde(range(min = 18))]
    age: u8,
}

fn strong_password(value: &str, _ctx: &()) -> garde::Result {
    let has_upper = value.chars().any(|c| c.is_uppercase());
    let has_digit = value.chars().any(|c| c.is_numeric());

    if !has_upper || !has_digit {
        return Err(garde::Error::new("å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯å’Œæ•°å­—"));
    }
    Ok(())
}

/// ç”¨æˆ·æ³¨å†Œ
#[post("/register")]
async fn register(
    ValidatedJson(data): ValidatedJson<RegisterRequest>
) -> impl IntoResponse {
    // âœ… data å·²é€šè¿‡æ‰€æœ‰éªŒè¯
    Json(json!({
        "message": "æ³¨å†ŒæˆåŠŸ",
        "username": data.username
    }))
}

/// æ›´æ–°èµ„æ–™ï¼ˆå¯é€‰å­—æ®µï¼‰
#[derive(Deserialize, Validate)]
struct UpdateProfile {
    #[garde(length(min = 1, max = 50))]
    name: Option<String>,

    #[garde(length(max = 200))]
    bio: Option<String>,
}

#[put("/profile")]
async fn update_profile(
    ValidatedJson(data): ValidatedJson<UpdateProfile>
) -> impl IntoResponse {
    Json(json!({ "message": "èµ„æ–™æ›´æ–°æˆåŠŸ" }))
}

#[miko]
async fn main() {
    println!("ğŸš€ Server running on http://localhost:8080");
}
```

## ä¸ OpenAPI é›†æˆ

é…åˆ `utoipa` åœ¨ API æ–‡æ¡£ä¸­æ˜¾ç¤ºéªŒè¯è§„åˆ™:

```rust
use miko::*;

#[derive(Deserialize, Validate, ToSchema)]
struct CreateUser {
    #[garde(length(min = 3, max = 20))]
    #[schema(example = "john_doe", min_length = 3, max_length = 20)]
    username: String,

    #[garde(email)]
    #[schema(example = "john@example.com", format = "email")]
    email: String,

    #[garde(range(min = 18))]
    #[schema(example = 25, minimum = 18)]
    age: u8,
}

#[post("/users")]
#[u_tag("ç”¨æˆ·")]
#[u_response(status = 201, body = User)]
#[u_response(status = 422, description = "éªŒè¯å¤±è´¥")]
async fn create_user(
    ValidatedJson(data): ValidatedJson<CreateUser>
) -> impl IntoResponse {
    // ...
}
```

## æ›´å¤šéªŒè¯è§„åˆ™

Miko çš„ validation feature åŸºäº [garde](https://github.com/jprochazk/garde) åº“,æ”¯æŒæ›´å¤šéªŒè¯è§„åˆ™:

- **å­—ç¬¦ä¸²**: `ascii`, `alphanumeric`, `phone`, `credit_card`, `ip` ç­‰
- **æ•°å€¼**: `finite`, `byte_range` ç­‰
- **é›†åˆ**: `unique`, `contains`, `subset` ç­‰
- **æ—¶é—´**: `past`, `future` ç­‰

è¯¦è§ [garde æ–‡æ¡£](https://docs.rs/garde/latest/garde/)ã€‚

## ä¸‹ä¸€æ­¥

- ğŸ” æŸ¥çœ‹ [é”™è¯¯å¤„ç†](é”™è¯¯å¤„ç†.md) äº†è§£ç»Ÿä¸€é”™è¯¯æ ¼å¼
- ğŸ“– å­¦ä¹  [è¯·æ±‚æå–å™¨](è¯·æ±‚æå–å™¨.md) çš„å…¶ä»–ç”¨æ³•
- ğŸ“š äº†è§£ [OpenAPI é›†æˆ](OpenAPIé›†æˆ.md) ç”Ÿæˆ API æ–‡æ¡£
