# 数据验证

> **需要 `validation` feature**

Miko 提供 `ValidatedJson` 提取器,自动验证请求数据并返回统一的错误响应。底层使用 [garde](https://github.com/jprochazk/garde) 验证库。

## 核心功能

### ValidatedJson 提取器

用 `ValidatedJson` 替代 `Json`,自动执行验证:

```rust
use miko::*;

#[derive(Deserialize, Validate)]
struct CreateUser {
    #[garde(length(min = 3, max = 20))]
    username: String,

    #[garde(email)]
    email: String,

    #[garde(length(min = 8))]
    password: String,

    #[garde(range(min = 18, max = 120))]
    age: u8,
}

#[post("/users")]
async fn create_user(
    ValidatedJson(data): ValidatedJson<CreateUser>
) -> impl IntoResponse {
    // ✅ data 已通过验证
    Json(json!({
        "message": "用户创建成功",
        "username": data.username
    }))
}
```

**对比普通 Json 提取器:**

```rust
// ❌ 使用 Json - 无验证
#[post("/users")]
async fn create_user(Json(data): Json<CreateUser>) -> impl IntoResponse {
    // ⚠️ data 可能包含无效数据
    // 需要手动验证
}

// ✅ 使用 ValidatedJson - 自动验证
#[post("/users")]
async fn create_user(ValidatedJson(data): ValidatedJson<CreateUser>) -> impl IntoResponse {
    // ✅ data 已通过所有验证规则
}
```

### 自动错误响应

验证失败自动返回 422 错误:

```json
{
  "status": 422,
  "error": "VALIDATION_ERROR",
  "message": "Request validation failed",
  "details": {
    "fields": [
      {
        "field": "username",
        "message": "username length must be between 3 and 20",
        "code": "VALIDATION_FAILED"
      },
      {
        "field": "email",
        "message": "email has invalid format, expected: valid email address",
        "code": "VALIDATION_FAILED"
      }
    ]
  },
  "trace_id": "trace-123abc",
  "timestamp": 1234567890
}
```

> 错误响应格式与框架的 [错误处理](错误处理.md) 系统一致。

## 常用验证规则

### 字符串验证

```rust
#[derive(Deserialize, Validate)]
struct StringExample {
    // 长度限制
    #[garde(length(min = 3, max = 50))]
    username: String,

    // 邮箱格式
    #[garde(email)]
    email: String,

    // URL 格式
    #[garde(url)]
    website: Option<String>,

    // 正则表达式
    #[garde(pattern(r"^[A-Z]{2}\d{4}$"))]
    code: String,
}
```

### 数值验证

```rust
#[derive(Deserialize, Validate)]
struct NumberExample {
    // 范围
    #[garde(range(min = 18, max = 120))]
    age: u8,

    // 最小值
    #[garde(range(min = 0.0))]
    price: f64,
}
```

### 集合验证

```rust
#[derive(Deserialize, Validate)]
struct CollectionExample {
    // 数组长度
    #[garde(length(min = 1, max = 10))]
    tags: Vec<String>,

    // 验证数组内每个元素
    #[garde(dive)]
    items: Vec<Item>,
}

#[derive(Deserialize, Validate)]
struct Item {
    #[garde(length(min = 1))]
    name: String,
}
```

### 嵌套对象验证

```rust
#[derive(Deserialize, Validate)]
struct UserProfile {
    #[garde(length(min = 3))]
    username: String,

    // 验证嵌套对象
    #[garde(dive)]
    address: Address,
}

#[derive(Deserialize, Validate)]
struct Address {
    #[garde(length(min = 1))]
    street: String,

    #[garde(length(min = 1))]
    city: String,
}
```

## 自定义验证

### 简单自定义

```rust
#[derive(Deserialize, Validate)]
struct User {
    #[garde(custom(validate_username))]
    username: String,
}

fn validate_username(value: &str, _ctx: &()) -> garde::Result {
    if value.to_lowercase() == "admin" {
        return Err(garde::Error::new("用户名 'admin' 不可用"));
    }
    Ok(())
}
```

### 复杂验证逻辑

```rust
#[derive(Deserialize, Validate)]
struct CreateUser {
    #[garde(length(min = 8), custom(strong_password))]
    password: String,
}

fn strong_password(value: &str, _ctx: &()) -> garde::Result {
    let has_upper = value.chars().any(|c| c.is_uppercase());
    let has_lower = value.chars().any(|c| c.is_lowercase());
    let has_digit = value.chars().any(|c| c.is_numeric());

    if !has_upper || !has_lower || !has_digit {
        return Err(garde::Error::new(
            "密码必须包含大写字母、小写字母和数字"
        ));
    }
    Ok(())
}
```

## 完整示例

```rust
use miko::*;

#[derive(Deserialize, Validate)]
struct RegisterRequest {
    #[garde(length(min = 3, max = 20))]
    username: String,

    #[garde(email)]
    email: String,

    #[garde(length(min = 8), custom(strong_password))]
    password: String,

    #[garde(range(min = 18))]
    age: u8,
}

fn strong_password(value: &str, _ctx: &()) -> garde::Result {
    let has_upper = value.chars().any(|c| c.is_uppercase());
    let has_digit = value.chars().any(|c| c.is_numeric());

    if !has_upper || !has_digit {
        return Err(garde::Error::new("密码必须包含大写字母和数字"));
    }
    Ok(())
}

/// 用户注册
#[post("/register")]
async fn register(
    ValidatedJson(data): ValidatedJson<RegisterRequest>
) -> impl IntoResponse {
    // ✅ data 已通过所有验证
    Json(json!({
        "message": "注册成功",
        "username": data.username
    }))
}

/// 更新资料（可选字段）
#[derive(Deserialize, Validate)]
struct UpdateProfile {
    #[garde(length(min = 1, max = 50))]
    name: Option<String>,

    #[garde(length(max = 200))]
    bio: Option<String>,
}

#[put("/profile")]
async fn update_profile(
    ValidatedJson(data): ValidatedJson<UpdateProfile>
) -> impl IntoResponse {
    Json(json!({ "message": "资料更新成功" }))
}

#[miko]
async fn main() {
    println!("🚀 Server running on http://localhost:8080");
}
```

## 与 OpenAPI 集成

配合 `utoipa` 在 API 文档中显示验证规则:

```rust
use miko::*;

#[derive(Deserialize, Validate, ToSchema)]
struct CreateUser {
    #[garde(length(min = 3, max = 20))]
    #[schema(example = "john_doe", min_length = 3, max_length = 20)]
    username: String,

    #[garde(email)]
    #[schema(example = "john@example.com", format = "email")]
    email: String,

    #[garde(range(min = 18))]
    #[schema(example = 25, minimum = 18)]
    age: u8,
}

#[post("/users")]
#[u_tag("用户")]
#[u_response(status = 201, body = User)]
#[u_response(status = 422, description = "验证失败")]
async fn create_user(
    ValidatedJson(data): ValidatedJson<CreateUser>
) -> impl IntoResponse {
    // ...
}
```

## 更多验证规则

Miko 的 validation feature 基于 [garde](https://github.com/jprochazk/garde) 库,支持更多验证规则:

- **字符串**: `ascii`, `alphanumeric`, `phone`, `credit_card`, `ip` 等
- **数值**: `finite`, `byte_range` 等
- **集合**: `unique`, `contains`, `subset` 等
- **时间**: `past`, `future` 等

详见 [garde 文档](https://docs.rs/garde/latest/garde/)。

## 下一步

- 🔍 查看 [错误处理](错误处理.md) 了解统一错误格式
- 📖 学习 [请求提取器](请求提取器.md) 的其他用法
- 📚 了解 [OpenAPI 集成](OpenAPI集成.md) 生成 API 文档
