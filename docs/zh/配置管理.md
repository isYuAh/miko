# 配置管理

Miko 引入了全新的配置系统（基于 `config` crate），支持多格式配置文件（TOML, YAML, JSON, JSON5）、环境变量注入以及默认值机制。

## 配置文件

### 支持的格式

Miko 默认启用了 TOML 支持。你可以通过 feature 开启其他格式支持：

```toml
[dependencies]
# 默认支持 TOML
miko = "0.8"

# 开启 YAML 支持
miko = { version = "0.8", features = ["config-yaml"] }
```

### 基础配置

在项目根目录创建 `config.toml`（或 `config.yaml`, `config.json` 等）：

```toml
# [server] 替代了旧版的 [application]
[server]
host = "0.0.0.0"
port = 8080

[database]
url = "postgres://localhost/mydb"
max_connections = 10

[app]
name = "My Application"
debug = false
```

### 环境配置

Miko 会自动根据运行环境加载额外的配置文件，覆盖基础配置：

- **开发环境** (`debug` 构建或 `CONFIG_ENV=dev`)：加载 `config.dev.{ext}`
- **生产环境** (`release` 构建或 `CONFIG_ENV=prod`)：加载 `config.prod.{ext}`

例如，`config.dev.toml`：

```toml
[server]
port = 3000

[app]
debug = true
```

### 环境变量

Miko 支持通过环境变量覆盖配置。环境变量需以 `MIKO__` 开头，层级使用双下划线 `__` 分隔。

例如：

- `MIKO__SERVER__PORT=9090` 覆盖 `server.port`
- `MIKO__DATABASE__URL=...` 覆盖 `database.url`

## 自动加载

使用 `#[miko]` 宏时，配置系统会自动初始化：

```rust
use miko::*;
use miko::macros::*;

#[miko]
async fn main() {
    // 1. 加载 config.{toml,yaml,json}
    // 2. 加载 config.{env}.{toml,yaml,json}
    // 3. 加载 MIKO__ 环境变量
    // 4. 应用 server 配置并启动
}
```

## 在 Handler 中使用配置

### 使用 `#[config]` 注解

你可以直接将配置值注入到 Handler 参数中。

#### 1. 基础用法

```rust
#[get("/info")]
async fn app_info(
    #[config("app.name")] app_name: String,
    #[config("server.port")] port: u16,
) -> String {
    format!("App: {}, Port: {}", app_name, port)
}
```

#### 2. 带默认值的注入（新特性）

如果配置项可能不存在，你可以提供一个默认值（支持字面量）：

```rust
#[get("/feature")]
async fn feature_flag(
    // 如果 config 中没有 "app.enable_beta"，则使用默认值 false
    #[config("app.enable_beta:false")] beta: bool,

    // 字符串默认值
    #[config("app.theme:dark")] theme: String,

    // 数字默认值
    #[config("app.max_items:100")] max_items: u32,
) -> String {
    format!("Beta: {}, Theme: {}, Max: {}", beta, theme, max_items)
}
```

#### 3. 注入结构体

`#[config]` 支持注入任意实现了 `Deserialize` 的结构体：

```rust
#[derive(Deserialize)]
struct DatabaseConfig {
    url: String,
    max_connections: u32,
}

#[get("/db")]
async fn db_info(
    #[config("database")] db: DatabaseConfig
) -> String {
    format!("DB URL: {}", db.url)
}
```

## 程序化访问配置

如果你需要在 Handler 之外（例如在 `main` 函数或自定义组件中）访问配置：

```rust
use miko::app::config::{get_settings, get_settings_value};

fn some_function() {
    // 1. 获取整个配置对象 (config::Config)
    let settings = get_settings();
    let port = settings.get_int("server.port").unwrap_or(8080);

    // 2. 获取特定类型的配置值 (支持泛型)
    let app_name: String = get_settings_value("app.name").unwrap_or_default();
}
```

## 迁移指南 (v0.6 -> v0.8)

如果你是从旧版本升级，请注意以下破坏性变更：

1. **配置段变更**：`[application]` 段落现在改为 `[server]`。
    * `addr` -> `host`
    * `port` -> `port`
2. **API 变更**：
    * `ApplicationConfig` 已被移除，使用 `ServerSettings`。
    * `ApplicationConfig::load_()` 已被移除。
3. **依赖变更**：不再依赖 `toml` crate 进行解析，改为 `config` crate。

## 下一步

- 💉 使用 [依赖注入](依赖注入.md) 管理组件
- 🔍 了解 [请求提取器](请求提取器.md) 的用法
