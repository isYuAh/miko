# é…ç½®ç®¡ç†

Miko æä¾›äº†åŸºäº TOML çš„é…ç½®ç³»ç»Ÿï¼Œæ”¯æŒç¯å¢ƒåŒºåˆ†å’Œé…ç½®æ³¨å…¥ã€‚

## é…ç½®æ–‡ä»¶

### åŸºç¡€é…ç½®

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `config.toml`ï¼š

```toml
[application]
addr = "0.0.0.0"
port = 8080

[database]
url = "postgres://localhost/mydb"
max_connections = 10

[redis]
url = "redis://localhost"
timeout = 5

[app]
name = "My Application"
version = "1.0.0"
debug = false
```

### ç¯å¢ƒé…ç½®

Miko æ”¯æŒç¯å¢ƒç‰¹å®šçš„é…ç½®æ–‡ä»¶ï¼š

- `config.dev.toml` - å¼€å‘ç¯å¢ƒï¼ˆdebug æ¨¡å¼ï¼‰
- `config.prod.toml` - ç”Ÿäº§ç¯å¢ƒï¼ˆrelease æ¨¡å¼ï¼‰

ç¯å¢ƒé…ç½®ä¼šè‡ªåŠ¨ä¸åŸºç¡€é…ç½®åˆå¹¶ï¼Œç¯å¢ƒé…ç½®ä¼˜å…ˆçº§æ›´é«˜ã€‚

**config.dev.toml**ï¼š

```toml
[application]
port = 3000

[app]
debug = true
```

**config.prod.toml**ï¼š

```toml
[database]
url = "postgres://prod-server/mydb"
max_connections = 50

[app]
debug = false
```

## è‡ªåŠ¨åŠ è½½

ä½¿ç”¨ `#[miko]` å®æ—¶é…ç½®ä¼šè‡ªåŠ¨åŠ è½½ï¼š

```rust
use miko::*;

#[get("/")]
async fn index() -> &'static str {
    "Hello"
}

#[miko]
async fn main() {
    // é…ç½®å·²è‡ªåŠ¨åŠ è½½
    // router å¯ç”¨
}
```

`#[miko]` å®ä¼šï¼š
1. åŠ è½½ `config.toml`
2. æ ¹æ®ç¼–è¯‘æ¨¡å¼åˆå¹¶ `config.dev.toml` æˆ– `config.prod.toml`
3. å°†é…ç½®å­˜å‚¨åˆ°å…¨å±€å˜é‡

## æ‰‹åŠ¨åŠ è½½

å¦‚æœä¸ä½¿ç”¨ `#[miko]` å®ï¼Œæœ‰ä¸¤ç§æ–¹å¼æ‰‹åŠ¨åŠ è½½é…ç½®ï¼š

### æ–¹å¼ 1: ä½¿ç”¨ `Application::new_`ï¼ˆæ¨èï¼‰

`Application::new_` ä¼šè‡ªåŠ¨åŠ è½½é…ç½®æ–‡ä»¶ï¼š

```rust
use miko::{Router, Application};

#[tokio::main]
async fn main() {
    let router = Router::new()
        .get("/", handler);
    
    // è‡ªåŠ¨åŠ è½½ config.toml å’Œç¯å¢ƒé…ç½®
    Application::new_(router).run().await.unwrap();
}
```

### æ–¹å¼ 2: æ‰‹åŠ¨åŠ è½½é…ç½®

å¦‚æœéœ€è¦åœ¨åˆ›å»ºåº”ç”¨å‰è®¿é—®é…ç½®ï¼š

```rust
use miko::app::config::ApplicationConfig;
use miko::{Router, Application};

#[tokio::main]
async fn main() {
    // æ‰‹åŠ¨åŠ è½½é…ç½®
    let config = ApplicationConfig::load_().unwrap_or_default();
    
    println!("Starting on port {}", config.port);
    
    let router = Router::new()
        .get("/", handler);
    
    Application::new(config, router).run().await.unwrap();
}
```

## åœ¨ Handler ä¸­ä½¿ç”¨é…ç½®

### ä½¿ç”¨ `#[config]` æ³¨è§£

ç›´æ¥æ³¨å…¥é…ç½®å€¼åˆ° Handler å‚æ•°ï¼š

```rust
#[get("/info")]
async fn app_info(
    #[config("app.name")] app_name: String,
    #[config("app.version")] version: String,
    #[config("app.debug")] debug: bool,
) -> Json<serde_json::Value> {
    Json(json!({
        "name": app_name,
        "version": version,
        "debug": debug
    }))
}
```

### é…ç½®è·¯å¾„

ä½¿ç”¨ç‚¹å·åˆ†éš”çš„è·¯å¾„è®¿é—®åµŒå¥—é…ç½®ï¼š

```toml
[database]
host = "localhost"
port = 5432

[database.pool]
min = 5
max = 20
```

```rust
#[get("/db-config")]
async fn db_config(
    #[config("database.host")] host: String,
    #[config("database.port")] port: u16,
    #[config("database.pool.max")] max_connections: u32,
) -> String {
    format!("DB: {}:{}, Max: {}", host, port, max_connections)
}
```

### æ”¯æŒçš„ç±»å‹

`#[config]` æ”¯æŒæ‰€æœ‰å®ç° `serde::Deserialize` çš„ç±»å‹:

```rust
// åŸºç¡€ç±»å‹
#[config("port")] port: u16
#[config("debug")] debug: bool
#[config("name")] name: String
#[config("timeout")] timeout: f64

// é›†åˆç±»å‹
#[config("allowed_origins")] origins: Vec<String>
#[config("features")] features: HashMap<String, bool>

// è‡ªå®šä¹‰ç»“æ„ä½“
#[derive(Deserialize)]
struct DatabaseConfig {
    host: String,
    port: u16,
    database: String,
}

#[get("/db-config")]
async fn db_config(
    #[config("database")] db_config: DatabaseConfig
) -> String {
    format!("{}:{}/{}", db_config.host, db_config.port, db_config.database)
}

// å¯é€‰ç±»å‹
#[get("/optional")]
async fn optional_config(
    #[config("features.beta")] beta: Option<bool>
) -> String {
    format!("Beta enabled: {}", beta.unwrap_or(false))
}
```

## ç¨‹åºåŒ–è®¿é—®é…ç½®

### è·å–é…ç½®èŠ‚

```rust
use miko::app::config::load_config_section;
use serde::Deserialize;

#[derive(Deserialize)]
struct DatabaseConfig {
    url: String,
    max_connections: u32,
}

async fn init_db() -> Result<Database, Error> {
    let config: DatabaseConfig = load_config_section("database")?;
    Database::connect(&config.url).await
}
```

### è·å–å®Œæ•´é…ç½®

```rust
use miko::app::config::get_config;
use toml::Value;

fn get_feature_flag(name: &str) -> bool {
    let config = get_config();
    config.get("features")
        .and_then(|f| f.get(name))
        .and_then(|v| v.as_bool())
        .unwrap_or(false)
}
```


## ä¸‹ä¸€æ­¥

- ğŸ’‰ ä½¿ç”¨ [ä¾èµ–æ³¨å…¥](ä¾èµ–æ³¨å…¥.md) ç®¡ç†ç»„ä»¶
- ğŸ” äº†è§£ [è¯·æ±‚æå–å™¨](è¯·æ±‚æå–å™¨.md) çš„ç”¨æ³•
- ğŸ“– æŸ¥çœ‹ [åŸºç¡€æ¦‚å¿µ](åŸºç¡€æ¦‚å¿µ.md) ç†è§£æ¶æ„
