# åŸºç¡€æ¦‚å¿µ

æœ¬ç« èŠ‚ä»‹ç» Miko æ¡†æ¶çš„æ ¸å¿ƒæ¦‚å¿µå’Œæ¶æ„è®¾è®¡ã€‚

## æ ¸å¿ƒç»„ä»¶

Miko æ¡†æ¶ç”±ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶æ„æˆï¼š

```
Application (åº”ç”¨ç¨‹åº)
    â”œâ”€â”€ Router (è·¯ç”±å™¨)
    â”‚   â”œâ”€â”€ Handler (å¤„ç†å™¨)
    â”‚   â””â”€â”€ Middleware (ä¸­é—´ä»¶)
    â”œâ”€â”€ Config (é…ç½®)
    â””â”€â”€ DependencyContainer (ä¾èµ–å®¹å™¨)
```

### Application (åº”ç”¨ç¨‹åº)

`Application` æ˜¯æ¡†æ¶çš„å…¥å£ç‚¹ï¼Œè´Ÿè´£ï¼š
- ç®¡ç†åº”ç”¨é…ç½®
- æŒæœ‰è·¯ç”±æœåŠ¡
- å¯åŠ¨ HTTP æœåŠ¡å™¨

```rust
use miko::*;
use miko::macros::*;

let router = Router::new()
    .get("/", handler);

// ä½¿ç”¨æ–‡ä»¶é…ç½®
// ä½ å¯ä»¥
let app = Application::new_(router);
// æˆ–ä½¿ç”¨
let config = ApplicationConfig::load_().unwrap();
let app = Application::new(config, router);

// è¿è¡Œåº”ç”¨
app.run().await.unwrap();
```

### Router (è·¯ç”±å™¨)

`Router` è´Ÿè´£è·¯ç”±ç®¡ç†å’Œè¯·æ±‚åˆ†å‘ï¼š
- æ³¨å†Œè·¯ç”±åŠå…¶å¤„ç†å™¨
- ç®¡ç†å…¨å±€çŠ¶æ€
- åº”ç”¨ä¸­é—´ä»¶å±‚

```rust
let router = Router::new()
    .get("/users", list_users)
    .post("/users", create_user)
    .get("/users/{id}", get_user);
```

è·¯ç”±å™¨æ”¯æŒæ³›å‹çŠ¶æ€å‚æ•°ï¼š

```rust
struct AppState {
    db: Database,
    cache: Cache,
}

let state = Arc::new(AppState { /* ... */ });
let router = Router::new()
    .with_state(state)
    .get("/", handler);
```

### Handler (å¤„ç†å™¨)

Handler æ˜¯å¤„ç†è¯·æ±‚çš„å‡½æ•°ï¼Œå¯ä»¥æ˜¯ä»»ä½•æ»¡è¶³ä»¥ä¸‹æ¡ä»¶çš„å¼‚æ­¥å‡½æ•°ï¼š
- å‚æ•°å®ç° `FromRequest` æˆ– `FromRequestParts` traitï¼ˆæ³¨æ„åªæœ‰æœ€åä¸€ä¸ªå¯ä»¥æ˜¯FromRequestï¼‰
- è¿”å›ç±»å‹å®ç° `IntoResponse` trait

```rust
// æœ€ç®€å•çš„ handler
async fn simple() -> &'static str {
    "Hello"
}

// å¸¦å‚æ•°çš„ handler
async fn with_params(
    Path(id): Path<u32>,
    Json(data): Json<CreateUser>,
) -> Json<User> {
    // ...
}

// è¿”å› Result çš„ handler
async fn fallible() -> AppResult<Json<User>> {
    // ...
}
```

## è¯·æ±‚å¤„ç†æµç¨‹

Miko çš„è¯·æ±‚å¤„ç†éµå¾ªä»¥ä¸‹æµç¨‹ï¼š

```
HTTP è¯·æ±‚
    â†“
[Hyper Server]
    â†“
[Tower Middleware Stack]  â† ä¸­é—´ä»¶é“¾
    â†“
[Router]  â† è·¯ç”±åŒ¹é…
    â†“
[Extract Parameters]  â† æå–è¯·æ±‚æ•°æ®
    â†“
[Handler]  â† ä¸šåŠ¡é€»è¾‘
    â†“
[IntoResponse]  â† è½¬æ¢ä¸ºå“åº”
    â†“
[Tower Middleware Stack]  â† å“åº”ä¸­é—´ä»¶
    â†“
HTTP å“åº”
```

### 1. è·¯ç”±åŒ¹é…

Router æ ¹æ®è¯·æ±‚æ–¹æ³•å’Œè·¯å¾„æŸ¥æ‰¾å¯¹åº”çš„å¤„ç†å™¨ï¼š

```rust
// å®šä¹‰è·¯ç”±
router
    .get("/users", list_users)      // GET /users
    .get("/users/{id}", get_user)   // GET /users/123
    .post("/users", create_user);    // POST /users
```

è·¯å¾„å‚æ•°ä¼šè¢«æå–å¹¶å­˜å‚¨åœ¨ `PathParams` ä¸­ã€‚

### 2. å‚æ•°æå–

Handler çš„å‚æ•°ä¼šè‡ªåŠ¨ä»è¯·æ±‚ä¸­æå–ï¼š

```rust
async fn handler(
    Path(id): Path<u32>,           // ä»è·¯å¾„æå–
    Query(params): Query<MyQuery>, // ä»æŸ¥è¯¢å­—ç¬¦ä¸²æå–
    Json(body): Json<MyData>,      // ä»è¯·æ±‚ä½“æå–
    State(state): State<AppState>, // ä»å…¨å±€çŠ¶æ€æå–
) -> impl IntoResponse {
    // ...
}
```

æå–å™¨æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ‰§è¡Œï¼š
1. **FromRequestParts** - ä¸æ¶ˆè´¹è¯·æ±‚ä½“ï¼ˆPathã€Queryã€Headers ç­‰ï¼‰
2. **FromRequest** - å¯èƒ½æ¶ˆè´¹è¯·æ±‚ä½“ï¼ˆJsonã€Formã€Multipart ç­‰ï¼‰

> âš ï¸ **æ³¨æ„**: åªèƒ½æœ‰ä¸€ä¸ªæå–å™¨æ¶ˆè´¹è¯·æ±‚ä½“ï¼

### 3. ä¸šåŠ¡å¤„ç†

Handler æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œå¯ä»¥ï¼š
- è®¿é—®æ•°æ®åº“
- è°ƒç”¨å¤–éƒ¨æœåŠ¡
- å¤„ç†ä¸šåŠ¡è§„åˆ™
- è¿”å›ç»“æœæˆ–é”™è¯¯

### 4. å“åº”è½¬æ¢

è¿”å›å€¼é€šè¿‡ `IntoResponse` trait è½¬æ¢ä¸º HTTP å“åº”ï¼š

```rust
// ç›´æ¥è¿”å›å­—ç¬¦ä¸²
async fn text_response() -> &'static str {
    "Hello"
}

// è¿”å› JSON
async fn json_response() -> Json<User> {
    Json(user)
}

// è¿”å›å…ƒç»„ï¼ˆçŠ¶æ€ç  + æ•°æ®ï¼‰
async fn with_status() -> (StatusCode, Json<User>) {
    (StatusCode::CREATED, Json(user))
}

// è¿”å› Result
async fn fallible() -> AppResult<Json<User>> {
    Ok(Json(user))
}
```

## ç±»å‹ç³»ç»Ÿ

### FromRequest

ä»å®Œæ•´çš„è¯·æ±‚ä¸­æå–æ•°æ®ï¼Œå¯ä»¥æ¶ˆè´¹è¯·æ±‚ä½“ï¼š

```rust
pub trait FromRequest<S, M = ()>: Sized {
    fn from_request(req: Req, state: Arc<S>) -> FRFut<Self>;
}
```

å®ç° `FromRequest` çš„ç±»å‹ï¼š
- `Json<T>` - JSON è¯·æ±‚ä½“
- `Form<T>` - è¡¨å•æ•°æ®
- `Multipart` - æ–‡ä»¶ä¸Šä¼ ï¼Œè·å–åŸå§‹æµ
- `MultipartResult` - æ–‡ä»¶ä¸Šä¼ ï¼Œè·å–è§£æå®Œæˆåçš„ç»“æ„ä½“ï¼Œä¸ºäº†æ”¾ç½®å†…å­˜è¿‡å¤§ï¼Œä½¿ç”¨ä¸´æ—¶æ–‡ä»¶å­˜å‚¨ï¼Œé€šè¿‡MultipartFileDiskLinkerè®¿é—®
- `ValidatedJson<T>` - éªŒè¯çš„ JSONï¼ˆä½¿ç”¨gardeï¼‰

### FromRequestParts

ä»è¯·æ±‚çš„éƒ¨åˆ†ä¿¡æ¯ä¸­æå–æ•°æ®ï¼Œä¸æ¶ˆè´¹è¯·æ±‚ä½“ï¼š

```rust
pub trait FromRequestParts<S, M = ()>: Sized {
    fn from_request_parts(parts: &mut Parts, state: Arc<S>) -> FRFut<Self>;
}
```

å®ç° `FromRequestParts` çš„ç±»å‹ï¼š
- `Path<T>` - è·¯å¾„å‚æ•°
- `Query<T>` - æŸ¥è¯¢å‚æ•°
- `State<T>` - å…¨å±€çŠ¶æ€
- `HeaderMap` - è¯·æ±‚å¤´
- `Method` - HTTP æ–¹æ³•
- `Uri` - è¯·æ±‚ URI

### IntoResponse

å°†ç±»å‹è½¬æ¢ä¸º HTTP å“åº”ï¼š

```rust
pub trait IntoResponse {
    fn into_response(self) -> Response;
}
```

æ¡†æ¶ä¸ºä»¥ä¸‹ç±»å‹æä¾›äº†å®ç°ï¼š
- åŸºç¡€ç±»å‹ï¼š`&str`, `String`, `&[u8]`, `Vec<u8>`
- JSONï¼š`Json<T>`
- HTMLï¼š`Html<T>`
- å…ƒç»„ï¼š`(StatusCode, T)`, `(HeaderMap, T)`
- ç»“æœï¼š`Result<T, E>`

## Features é…ç½®

Miko é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œé€šè¿‡ Cargo features æ§åˆ¶åŠŸèƒ½ï¼š

```toml
[dependencies]
miko = { version = "0.3.5", features = ["full"] }
```

### å¯ç”¨ Features

| Feature | æè¿° | åŒ…å«å†…å®¹ |
|---------|------|----------|
| `full` | æ‰€æœ‰åŠŸèƒ½ | åŒ…å«ä¸‹é¢æ‰€æœ‰ features |
| `macro` | è·¯ç”±å® | `#[get]`, `#[post]` ç­‰è·¯ç”±å® |
| `auto` | è‡ªåŠ¨åŠŸèƒ½ | è‡ªåŠ¨è·¯ç”±æ³¨å†Œã€ä¾èµ–æ³¨å…¥ |
| `ext` | æ‰©å±•åŠŸèƒ½ | CORSã€é™æ€æ–‡ä»¶æœåŠ¡ |
| `utoipa` | OpenAPI | API æ–‡æ¡£ç”Ÿæˆ |
| `validation` | æ•°æ®éªŒè¯ | garde é›†æˆ |

### æŒ‰éœ€å¯ç”¨

```toml
# åªå¯ç”¨éœ€è¦çš„åŠŸèƒ½
miko = { version = "0.3.5", features = ["macro", "auto"] }
```

### æœ€å°é…ç½®

ä¸ä½¿ç”¨ä»»ä½• featureï¼š

```toml
miko = "0.3.5"
```

æ­¤æ—¶åªèƒ½ä½¿ç”¨æ ¸å¿ƒåŠŸèƒ½ï¼Œéœ€æ‰‹åŠ¨æ³¨å†Œè·¯ç”±ï¼š

```rust
let router = Router::new()
    .route("/", Method::GET, handler);
```

## å¼‚æ­¥è¿è¡Œæ—¶

Miko åŸºäº Tokio è¿è¡Œæ—¶æ„å»ºï¼Œéœ€è¦åœ¨å¼‚æ­¥ä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼š

```rust
#[tokio::main]
async fn main() {
    let router = Router::new()
        .get("/", handler);

    Application::new_(router)
        .run()
        .await
        .unwrap();
}
```

æ‰€æœ‰çš„ handler éƒ½æ˜¯å¼‚æ­¥å‡½æ•°ï¼š

```rust
async fn handler() -> &'static str {
    // å¯ä»¥æ‰§è¡Œå¼‚æ­¥æ“ä½œ
    tokio::time::sleep(Duration::from_secs(1)).await;
    "Hello"
}
```

## Tower ç”Ÿæ€é›†æˆ

Miko å®Œå…¨å…¼å®¹ [Tower](https://github.com/tower-rs/tower) ç”Ÿæ€ç³»ç»Ÿï¼š

```rust
use tower::ServiceBuilder;
use tower_http::compression::CompressionLayer;

router.service(
        "/no_macro",
        handler
            .with_state(Arc::new(router.state.clone())) //éœ€è¦å…ˆç¡®å®šstateï¼Œè½¬æ¢ä¸ºService
            .layer(layer), //Serviceå¯ä»¥é“¾å¼è°ƒç”¨åº”ç”¨layer
    ); // ä½¿ç”¨ Tower ä¸­é—´ä»¶
```

è¿™ä½¿å¾—ä½ å¯ä»¥ä½¿ç”¨ Tower ç”Ÿæ€ç³»ç»Ÿä¸­çš„å¤§é‡ä¸­é—´ä»¶ï¼Œå¦‚ï¼š
- `tower-http` - HTTP ç›¸å…³ä¸­é—´ä»¶
- `tower-governor` - é™æµ
- `tower-timeout` - è¶…æ—¶æ§åˆ¶

è¯¦è§ [ä¸­é—´ä»¶ä¸å±‚](ä¸­é—´ä»¶ä¸å±‚.md)ã€‚

## é”™è¯¯å¤„ç†

Miko æä¾›ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

```rust
use miko::{AppError, AppResult};

async fn handler() -> AppResult<Json<User>> {
    let user = get_user()
        .await
        .map_err(|e| AppError::NotFound(format!("User not found: {}", e)))?;

    Ok(Json(user))
}
```

æ¡†æ¶ä¼šè‡ªåŠ¨å°†é”™è¯¯è½¬æ¢ä¸ºæ ‡å‡†çš„ JSON å“åº”æ ¼å¼ï¼š

```json
{
    "status": 404,
    "error": "NOT_FOUND",
    "message": "404 Not Found",
    "trace_id": "trace-641d28a04dfe2-ThreadId3",
    "timestamp": 1761222374
}
```

è¯¦è§ [é”™è¯¯å¤„ç†](é”™è¯¯å¤„ç†.md)ã€‚

## ä¾èµ–æ³¨å…¥

ä½¿ç”¨ `#[component]` å’Œ `#[dep]` å®ç°ä¾èµ–æ³¨å…¥ï¼š

```rust
#[component]
impl Database {
    async fn new() -> Self {
        Self::connect().await
    }
}

#[get("/users")]
async fn list_users(#[dep] db: Arc<Database>) -> Json<Vec<User>> {
    // ä½¿ç”¨æ³¨å…¥çš„æ•°æ®åº“å®ä¾‹
}
```

> **éœ€è¦ `auto` feature**

è¯¦è§ [ä¾èµ–æ³¨å…¥](ä¾èµ–æ³¨å…¥.md)ã€‚

## ä¸‹ä¸€æ­¥

- ğŸ“– å­¦ä¹  [è·¯ç”±ç³»ç»Ÿ](è·¯ç”±ç³»ç»Ÿ.md) çš„è¯¦ç»†ç”¨æ³•
- ğŸ” äº†è§£ [è¯·æ±‚æå–å™¨](è¯·æ±‚æå–å™¨.md) çš„ç§ç±»å’Œç”¨æ³•
- ğŸ“¤ æŒæ¡ [å“åº”å¤„ç†](å“åº”å¤„ç†.md) çš„å„ç§æ–¹å¼
- âš ï¸ æ·±å…¥ [é”™è¯¯å¤„ç†](é”™è¯¯å¤„ç†.md) æœºåˆ¶
